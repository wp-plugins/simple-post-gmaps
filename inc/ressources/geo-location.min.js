var geoForm=function(c,b){var d=this;this.options=jQuery.extend({},this.options,b);this.form=c;if(c.is("form")){this.topForm=c;}else{this.topForm=c.parents("form:first");}this.sendCheck=jQuery(".geo-auto-detect",c).click(function(){d.enable.call(d);});jQuery(".geo-address-find",c).click(function(){return d.geocode();});jQuery(".geo-address",c).keypress(function(e){if(13!=e.keyCode){return true;}return d.geocode();}).blur(function(){d.geocode();});var a=jQuery(".geo-enable").change(function(){if(jQuery(this).is(":checked")){d.form.show();d.initMap();}else{d.form.hide();}});if(!a.size()||a.is(":checked")){this.initMap();}this.setPosition=function(){return d._setPosition.apply(d,arguments);};this.handlePositionError=function(){return d._handlePositionError.apply(d,arguments);};};if("undefined"!=typeof navigator&&navigator.geolocation){geoForm.geolocation=navigator.geolocation;}else{if(window.google&&google.gears){geoForm.geolocation=google.gears.factory.create("beta.geolocation");}}geoForm.geocodeSortLook={ROOFTOP:0,RANGE_INTERPOLATED:1,GEOMETRIC_CENTER:2,APPROXIMATE:3};geoForm.geocodeSort=function(d,c){return geoForm.geocodeSortLook[d.geometry.location_type]-geoForm.geocodeSortLook[c.geometry.location_type];};geoForm.prototype={form:null,topForm:null,options:{postName:"geo",error:null},sendCheck:null,map:false,mapInitialized:false,address:false,geocoding:false,position:false,fields:["latitude","longitude","accuracy"],marker:false,accuracyCircle:false,accuracyBound:false,initMap:function(){if(this.mapInitialized){return;}var g=this,d=jQuery(".geo-map",this.form);if(!d.is(":visible")){return;}if(d.size()){var c=jQuery(".latitude",this.form),f=jQuery(".longitude",this.form),b=jQuery(".accuracy",this.form),e,a=new google.maps.LatLng(c.val()||c.attr("title")||c.text(),f.val()||f.attr("title")||f.text());this.map=new google.maps.Map(d.get(0),{zoom:this.options.zoom||0,center:a,mapTypeId:google.maps.MapTypeId.ROADMAP});google.maps.event.addListener(this.map,"click",function(h){this.marker=new google.maps.Marker({position:h.latLng,map:this.map});g.setFields(h.latLng);g.reverseGeocode(h.latLng);});e=b.val()||b.attr("title")||b.text();this.centerMap(a,e);}else{this.map=false;}this.mapInitialized=true;},enable:function(){this.preventSubmit();if(this.position){this.setPosition(this.position);this.allowSubmit();}else{geoForm.geolocation.getCurrentPosition(this.setPosition,this.handlePositionError,{timeout:6000});}},_setPosition:function(a){var b=this;this.position=a;setTimeout(function(){var c=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);b.reverseGeocode(c);},10);this.setFields(a.coords);this.allowSubmit();if(this.map){this.centerMap();}},setFields:function(b){var f=this,a,e,c,d;if(b.location_type&&b.bounds){a=b.location;d=new google.maps.LatLng(b.bounds.getSouthWest().lat(),b.bounds.getNorthEast().lng());e=(f.distance(b.bounds.getSouthWest(),d)+f.distance(b.bounds.getNorthEast(),d))/4;b=b.location;}else{if(b.location_type){a=b.location;e=false;b=b.location;}else{if(b.constructor==google.maps.LatLng){a=b;e=false;}}}if(b.constructor==google.maps.LatLng){jQuery.each(this.fields,function(){if("latitude"==this){jQuery(".latitude",f.form).val(b.lat());}else{if("longitude"==this){jQuery(".longitude",f.form).val(b.lng());}else{if("accuracy"==this){jQuery(".accuracy",f.form).val(e);}else{jQuery("."+this,f.form).val("");}}}});}else{a=new google.maps.LatLng(b.latitude,b.longitude),e=b.accuracy;jQuery.each(this.fields,function(){var h="",g;if(("undefined"!=typeof b[this])&&b[this]){h=b[this];}g=f.form.find("."+this);if(g.size()){g.val(h);}else{f.form.append('<input type="hidden" class="geo-field '+this+'" name="'+f.options.postName+"["+this+']" value="'+h+'" />');}});}if(!this.map){return;}if(e){if(this.marker){this.marker.setMap();this.marker=false;}this.drawCircle(this.map,a,parseInt(e)/1000,100);}else{if(this.accuracyCircle){this.accuracyCircle.setMap();this.accuracyCircle=false;}c={position:a,map:this.map};if(this.marker){this.marker.setOptions(c);}else{this.marker=new google.maps.Marker(c);}}},centerMap:function(a,b){if(!a){if(this.accuracyCircle){this.map.fitBounds(this.accuracyBound);}else{if(this.marker){this.map.setCenter(this.marker.getPosition());}}return;}if(b){if(0==b){if(this.marker){this.marker.setPosition(a);this.marker.setMap(this.map);}else{this.marker=new google.maps.Marker({position:a,map:this.map});this.map.setZoom(8);}}else{this.drawCircle(this.map,a,parseInt(b)/1000,100);this.map.fitBounds(this.accuracyBound);}}this.map.setCenter(a);},_handlePositionError:function(a){this.allowSubmit();this.sendCheck.attr("checked",false);if("function"==typeof this.options.error){this.options.error(a);}},disable:function(){this.form.find(".geo-field").remove();this.allowSubmit();},preventSubmit:function(){var a=this;jQuery(".geo-throbber",this.form).css("visibility","visible");this.topForm.find("[type=submit]").attr("disabled","disabled");this.topForm.bind("submit.geoForm",function(){return false;});setTimeout(function(){a.allowSubmit.call(a);},6000);},allowSubmit:function(){jQuery(".geo-throbber",this.form).css("visibility","hidden");this.topForm.find("[type=submit]").attr("disabled",false);this.topForm.unbind("submit.geoForm");},geocode:function(){if(this.geocoding){return false;}this.geocoding=true;var b=this,a=new google.maps.Geocoder;if(b.address==jQuery(".geo-address",b.form).val()){b.geocoding=false;return true;}this.preventSubmit();a.geocode({address:jQuery(".geo-address",b.form).val()},function(d,c){b.geocoding=false;if("OK"!=c){b.allowSubmit();return;}d.sort(geoForm.geocodeSort);b.setFields(d[0].geometry);b.allowSubmit();b.address=jQuery(".geo-address",b.form).val();if(b.map){b.centerMap();}});return false;},reverseGeocode:function(a){var c=this,b=new google.maps.Geocoder;b.geocode({latLng:a},function(e,d){if("OK"!=d){return;}e.sort(geoForm.geocodeSort);c.form.find(".geo-address").val(e[0].formatted_address);c.address=jQuery(".geo-address",c.form).val();});},drawCircle:function(e,d,j,f){if(this.accuracyCircle){this.accuracyCircle.setMap();}this.accuracyBound=new google.maps.LatLngBounds();var g=[];var c=j/6378.8;var i=Math.PI/180*d.lat();var o=Math.PI/180*d.lng();f=f||24;var b=360/f;for(var n=0;n<361;n=n+b){var h=Math.PI/180*n;var l=Math.asin(Math.sin(i)*Math.cos(c)+Math.cos(i)*Math.sin(c)*Math.cos(h));var k=Math.atan2(Math.sin(h)*Math.sin(c)*Math.cos(i),Math.cos(c)-Math.sin(i)*Math.sin(l));var m=((o-k+Math.PI)%(2*Math.PI))-Math.PI;var p=new google.maps.LatLng(parseFloat(l*180/Math.PI),parseFloat(m*180/Math.PI));g.push(p);this.accuracyBound.extend(p);}if(jQuery.browser.msie){return;}this.accuracyCircle=new google.maps.Polygon({paths:g,strokeColor:"#FF0000",strokeOpacity:0.5,strokeWeight:2,fillColor:"#FF0000",fillOpacity:0.2});this.accuracyCircle.setMap(e);},distance:function(e,c){var d=(c.lat()-e.lat())*Math.PI/180,f=(c.lng()-e.lng())*Math.PI/180,g=Math.sin(d/2)*Math.sin(d/2)+Math.cos(e.lat()*Math.PI/180)*Math.cos(c.lat()*Math.PI/180)*Math.sin(f/2)*Math.sin(f/2);return 6371000*2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g));}};jQuery(function(a){if(!geoForm.geolocation){if(!google.loader.ClientLocation){return;}geoForm.geolocation={getCurrentPosition:function(d,c,b){d({coords:{latitude:google.loader.ClientLocation.latitude,longitude:google.loader.ClientLocation.longitude}});}};}a(".hide-if-no-geo").show();a(".hide-if-geo").hide();});